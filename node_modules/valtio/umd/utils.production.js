!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("valtio/vanilla"),require("proxy-compare")):"function"==typeof define&&define.amd?define(["exports","valtio/vanilla","proxy-compare"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).valtioUtils={},t.valtioVanilla,t.proxyCompare)}(this,(function(t,e,n){"use strict";var r;var i=Symbol();var a=new WeakMap,o=new WeakMap,s=function t(e){var n=a.get(e);n&&(n[0].forEach((function(n){var r=n.d;e!==r&&t(r)})),++n[2])},u=function t(e){var n=a.get(e);if(n){if(--n[2],!n[2]){var r=new Set(n[3]);n[3].clear(),r.forEach((function(t){return t()}))}n[0].forEach((function(n){var r=n.d;e!==r&&t(r)}))}},c=function(t){var n=t.s,r=t.d,i=o.get(r);i||(i=[new Set],o.set(t.d,i)),i[0].add(t);var c=a.get(n);if(!c){var f=new Set,d=e.subscribe(n,(function(t){f.forEach((function(e){var r=e.d,i=e.c,a=e.n,o=e.i;n===r&&t.every((function(t){return 1===t[1].length&&o.includes(t[1][0])}))||e.p||(s(n),a?(i(),u(n)):e.p=Promise.resolve().then((function(){delete e.p,i(),u(n)})))}))}),!0);c=[f,d,0,new Set],a.set(n,c)}c[0].add(t)},f=function(t){var e=t.s,n=t.d,r=o.get(n);null==r||r[0].delete(t),0===(null==r?void 0:r[0].size)&&o.delete(n);var i=a.get(e);if(i){var s=i[0],u=i[1];s.delete(t),s.size||(u(),a.delete(e))}},d=function(t){var e=o.get(t);return e?Array.from(e[0]):[]},l={add:c,remove:f,list:d};function p(t,n){var r=(null==n?void 0:n.proxy)||e.proxy({}),i=!(null==n||!n.sync),o=Object.keys(t);return o.forEach((function(n){if(Object.getOwnPropertyDescriptor(r,n))throw new Error("object property already defined");var s=t[n],u=null;!function t(){if(u){if(Array.from(u).map((function(e){var n,r,i,o=e[0];return n=o,r=t,!(null==(i=a.get(n))||!i[2]||(i[3].add(r),0))})).some((function(t){return t})))return;if(Array.from(u).every((function(t){var n=t[0],r=t[1];return e.getVersion(n)===r.v})))return}var d=new Map,l=s((function(t){return d.set(t,{v:e.getVersion(t)}),t})),p=function(){var e;d.forEach((function(e,a){var s,f,d=null==(s=u)||null==(f=s.get(a))?void 0:f.s;if(d)e.s=d;else{var l={s:a,d:r,k:n,c:t,n:i,i:o};c(l),e.s=l}})),null==(e=u)||e.forEach((function(t,e){!d.has(e)&&t.s&&f(t.s)})),u=d};l instanceof Promise?l.finally(p):p(),r[n]=l}()})),r}function h(t,e){for(var n in e){(a=e[n]).configurable=a.enumerable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,n,a)}if(Object.getOwnPropertySymbols)for(var r=Object.getOwnPropertySymbols(e),i=0;i<r.length;i++){var a,o=r[i];(a=e[o]).configurable=a.enumerable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,o,a)}return t}t.addComputed=function(t,e,n){void 0===n&&(n=t),console.warn("addComputed is deprecated. Please consider using `derive` or `proxyWithComputed` instead. Falling back to emulation with derive.");var r={};return Object.keys(e).forEach((function(n){r[n]=function(r){return e[n](r(t))}})),p(r,{proxy:n})},t.derive=p,t.devtools=function(t,n){var r;try{r=window.__REDUX_DEVTOOLS_EXTENSION__}catch(t){}if(r){var a=!1,o=r.connect({name:n}),s=e.subscribe(t,(function(n){var r=n.filter((function(t){return t[0],t[1][0]!==i})).map((function(t){return t[0]+":"+t[1].map(String).join(".")})).join(", ");if(r)if(a)a=!1;else{var s=Object.assign({},e.snapshot(t));delete s[i],o.send({type:r,updatedAt:(new Date).toLocaleString()},s)}})),u=o.subscribe((function(n){var r,s;if("ACTION"===n.type&&n.payload)try{Object.assign(t,JSON.parse(n.payload))}catch(t){console.error("please dispatch a serializable value that JSON.parse() and proxy() support\n",t)}if("DISPATCH"===n.type&&n.state){var u,c;if("JUMP_TO_ACTION"===(null==(u=n.payload)?void 0:u.type)||"JUMP_TO_STATE"===(null==(c=n.payload)?void 0:c.type)){a=!0;var f=JSON.parse(n.state);Object.assign(t,f)}t[i]=n}else if("DISPATCH"===n.type&&"COMMIT"===(null==(r=n.payload)?void 0:r.type))o.init(e.snapshot(t));else if("DISPATCH"===n.type&&"IMPORT_STATE"===(null==(s=n.payload)?void 0:s.type)){var d,l,p=null==(d=n.payload.nextLiftedState)?void 0:d.actionsById,h=(null==(l=n.payload.nextLiftedState)?void 0:l.computedStates)||[];a=!0,h.forEach((function(n,r){var i=n.state,a=p[r]||"No action found";Object.assign(t,i),0===r?o.init(e.snapshot(t)):o.send(a,e.snapshot(t))}))}}));return o.init(e.snapshot(t)),function(){s(),u()}}},t.proxyMap=function(t){var n,r,i,a=e.proxy((r={data:Array.from(t||[]),has:function(t){return this.data.some((function(e){return e[0]===t}))},set:function(t,e){var n=this.data.find((function(e){return e[0]===t}));return n?n[1]=e:this.data.push([t,e]),this},get:function(t){var e;return null==(e=this.data.find((function(e){return e[0]===t})))?void 0:e[1]},delete:function(t){var e=this.data.findIndex((function(e){return e[0]===t}));return-1!==e&&(this.data.splice(e,1),!0)},clear:function(){this.data.splice(0)},get size(){return this.data.length},toJSON:function(){return{}},forEach:function(t){var e=this;this.data.forEach((function(n){t(n[1],n[0],e)}))},keys:function(){return this.data.map((function(t){return t[0]})).values()},values:function(){return this.data.map((function(t){return t[1]})).values()},entries:function(){return new Map(this.data).entries()}},(i={})[n=Symbol.toStringTag]=i[n]||{},i[n].get=function(){return"Map"},r[Symbol.iterator]=function(){return this.entries()},h(r,i),r));return Object.defineProperties(a,{data:{enumerable:!1},size:{enumerable:!1},toJSON:{enumerable:!1}}),Object.seal(a),a},t.proxySet=function(t){var n,r,i,a=e.proxy((r={data:Array.from(new Set(t)),has:function(t){return-1!==this.data.indexOf(t)},add:function(t){var n=!1;return"object"==typeof t&&null!==t&&(n=-1!==this.data.indexOf(e.proxy(t))),-1!==this.data.indexOf(t)||n||this.data.push(t),this},delete:function(t){var e=this.data.indexOf(t);return-1!==e&&(this.data.splice(e,1),!0)},clear:function(){this.data.splice(0)},get size(){return this.data.length},forEach:function(t){var e=this;this.data.forEach((function(n){t(n,n,e)}))}},(i={})[n=Symbol.toStringTag]=i[n]||{},i[n].get=function(){return"Set"},r.toJSON=function(){return{}},r[Symbol.iterator]=function(){return this.data[Symbol.iterator]()},r.values=function(){return this.data.values()},r.keys=function(){return this.data.values()},r.entries=function(){return new Set(this.data).entries()},h(r,i),r));return Object.defineProperties(a,{data:{enumerable:!1},size:{enumerable:!1},toJSON:{enumerable:!1}}),Object.seal(a),a},t.proxyWithComputed=function(t,r){Object.keys(r).forEach((function(a){if(Object.getOwnPropertyDescriptor(t,a))throw new Error("object property already defined");var o,s,u=r[a],c="function"==typeof u?{get:u}:u,f=c.get,d=c.set,l=new WeakMap,p={get:function(){var t=e.snapshot(i);return s&&!n.isChanged(s,t,l)||(l=new WeakMap,o=f(n.createProxy(t,l)),s=t),o}};d&&(p.set=function(t){return d(i,t)}),Object.defineProperty(t,a,p)}));var i=e.proxy(t);return i},t.proxyWithHistory=function(t,n){void 0===n&&(n=!1);var r=e.proxy({value:t,history:e.ref({wip:t,snapshots:[],index:-1}),canUndo:function(){return r.history.index>0},undo:function(){r.canUndo()&&(r.value=r.history.wip=r.history.snapshots[--r.history.index],r.history.snapshots[r.history.index]=e.snapshot(r).value)},canRedo:function(){return r.history.index<r.history.snapshots.length-1},redo:function(){r.canRedo()&&(r.value=r.history.wip=r.history.snapshots[++r.history.index],r.history.snapshots[r.history.index]=e.snapshot(r).value)},saveHistory:function(){r.history.snapshots.splice(r.history.index+1),r.history.snapshots.push(e.snapshot(r).value),++r.history.index},subscribe:function(){return e.subscribe(r,(function(t){t.every((function(t){return"value"===t[1][0]&&("set"!==t[0]||t[2]!==r.history.wip)}))&&r.saveHistory()}))}});return r.saveHistory(),n||r.subscribe(),r},t.subscribeKey=function(t,n,r,i){return e.subscribe(t,(function(e){e.some((function(t){return t[1][0]===n}))&&r(t[n])}),i)},t.underive=function(t,e){var n=null!=e&&e.delete?new Set:null;d(t).forEach((function(t){var r=t.k;null!=e&&e.keys&&!e.keys.includes(r)||(f(t),n&&n.add(r))})),n&&n.forEach((function(e){delete t[e]}))},t.unstable_deriveSubscriptions=l,t.watch=function(t,n){var i=new Set,a=new Set,o=!0,s=function(){i.forEach((function(t){t()})),i.clear(),a.clear()},u=function(){o&&(s(),o=!1)};return r&&r.add(u),function u(){if(o){s();var c=r;r=i;try{var f=t((function(t){return a.add(t),t}));f&&i.add(f)}finally{r=c}a.forEach((function(t){var r=e.subscribe(t,u,null==n?void 0:n.sync);i.add(r)}))}}(),u},Object.defineProperty(t,"__esModule",{value:!0})}));
